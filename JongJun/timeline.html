<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸ ì¼ì • ìƒì„¸</title>
    <?!= include('style'); ?>
    <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <style>
        /* ì¶”ê°€ì ì¸ íƒ€ì„ë¼ì¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        body {
            background: #f0f2f5; /* Light grey background for results page */
        }
        .container {
            max-width: 1200px; /* Wider container for Gantt chart */
            padding: 20px;
            box-shadow: none; /* Remove main container shadow */
            background: none;
        }
        .header {
            background: none;
            color: #333;
            text-align: left;
            padding: 20px 0;
        }
        .header h1 {
            font-size: 2em;
            color: #00a632;
        }
        .header p {
            color: #666;
        }
        .timeline-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 20px;
            overflow-x: auto; /* Gantt chart can be wide */
        }
        .gantt-container {
            /* Frappe Gantt ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
            width: 100%;
            min-height: 400px;
        }
        #timelineDetails {
            margin-top: 40px;
        }
        .week-detail {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            padding: 25px;
            border-left: 5px solid #00c73c;
        }
        .week-detail h4 {
            color: #00a632;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .week-detail p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .week-detail ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .week-detail ul li {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: #444;
        }
        .week-detail ul li strong {
            color: #00c73c;
        }
        .week-detail .task-status {
            font-weight: 600;
            color: #00c73c; /* Default for 'ê³„íš' */
        }
        .week-detail .task-status.in-progress { color: #ff9800; } /* 'ì§„í–‰ ì¤‘' */
        .week-detail .task-status.completed { color: #4CAF50; } /* 'ì™„ë£Œ' */

        .week-detail .risks-section {
            margin-top: 15px;
            border-top: 1px dashed #eee;
            padding-top: 15px;
        }
        .week-detail .risks-section strong {
            color: #e53935;
            font-size: 0.9em;
            display: block;
            margin-bottom: 5px;
        }
        .week-detail .risks-section p {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 5px;
        }
        .back-button {
            display: inline-block;
            background: #607d8b;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            margin-top: 20px;
            transition: background 0.3s ease;
        }
        .back-button:hover {
            background: #455a64;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="<?= ScriptApp.get  Url() ?>" class="back-button">â† ë‹¤ì‹œ ìƒì„±í•˜ê¸°</a>
        <h1>ğŸ“‹ AI ì¶”ì²œ í”„ë¡œì íŠ¸ íƒ€ì„ë¼ì¸</h1>
        <p id="projectSummary"></p>
    </div>

    <div class="timeline-container">
        <h3 style="color: #00a632; margin-bottom: 20px;">ğŸ—“ï¸ í”„ë¡œì íŠ¸ ê°œìš” (ê°„íŠ¸ ì°¨íŠ¸)</h3>
        <svg id="ganttChart" class="gantt-container"></svg>
    </div>

    <div id="timelineDetails" class="timeline-container">
        <h3 style="color: #00a632; margin-bottom: 20px;">âœ¨ ì£¼ì°¨ë³„ ìƒì„¸ ì¼ì •</h3>
        </div>
</div>

<script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const aiResponseJson = localStorage.getItem('projectTimelineData');
        const projectDataJson = localStorage.getItem('projectFormData');

        if (!aiResponseJson || !projectDataJson) {
            alert('ì´ì „ í”„ë¡œì íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.');
            window.location.href = '<?= ScriptApp.get  Url() ?>'; // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            return;
        }

        try {
            const timelineData = JSON.parse(aiResponseJson);
            const projectData = JSON.parse(projectDataJson);

            // í”„ë¡œì íŠ¸ ìš”ì•½ í‘œì‹œ
            document.getElementById('projectSummary').textContent =
                `${projectData.projectName} | ${projectData.projectType} | ì˜ˆìƒ ${projectData.duration}ì£¼ | íŒ€ ${projectData.teamSize}`;

            // 1. Frappe Gantt ì°¨íŠ¸ ë Œë”ë§
            const ganttTasks = timelineData.flatMap(week => {
                const weekNum = parseInt(week.week.match(/\d+/)[0]);
                const startDate = new Date(); // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€
                startDate.setDate(startDate.getDate() + (weekNum - 1) * 7); // ì£¼ì°¨ ì‹œì‘ì¼ ê³„ì‚°

                // ì£¼ì°¨ë³„ 'tasks' ë°°ì—´ì´ ìˆë‹¤ë©´ ì´ë¥¼ ê°„íŠ¸ ì°¨íŠ¸ì˜ ì„¸ë¶€ taskë¡œ ë³€í™˜
                if (week.tasks && week.tasks.length > 0) {
                    return week.tasks.map((task, idx) => {
                        // ê° taskì˜ durationì„ ì²˜ë¦¬ (ì˜ˆ: "3ì¼" -> 3)
                        const durationDaysMatch = task.duration.match(/(\d+)/);
                        const durationDays = durationDaysMatch ? parseInt(durationDaysMatch[1]) : 1;

                        const taskStartDate = new Date(startDate);
                        const taskEndDate = new Date(startDate);
                        taskEndDate.setDate(taskEndDate.getDate() + durationDays -1); // durationì´ 1ì¼ì´ë©´ ì‹œì‘ì¼ê³¼ ë™ì¼

                        // Frappe GanttëŠ” ë‚ ì§œ í¬ë§· 'YYYY-MM-DD'ë¥¼ ì„ í˜¸
                        const formatGanttDate = (date) => date.toISOString().split('T')[0];

                        return {
                            id: `task-${weekNum}-${idx}`,
                            name: `${week.week}: ${task.name}`,
                            start: formatGanttDate(taskStartDate),
                            end: formatGanttDate(taskEndDate),
                            progress: task.status === 'ì™„ë£Œ' ? 100 : (task.status === 'ì§„í–‰ ì¤‘' ? 50 : 0),
                            custom_class: task.status === 'ì™„ë£Œ' ? 'bar-completed' : (task.status === 'ì§„í–‰ ì¤‘' ? 'bar-in-progress' : 'bar-planned')
                        };
                    });
                } else {
                    // ì£¼ì°¨ì— ì„¸ë¶€ taskê°€ ì—†ëŠ” ê²½ìš°, ì£¼ì°¨ ìì²´ë¥¼ í•˜ë‚˜ì˜ taskë¡œ í‘œí˜„
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 6); // 1ì£¼ = 7ì¼

                    const formatGanttDate = (date) => date.toISOString().split('T')[0];

                    return [{
                        id: `week-${weekNum}`,
                        name: `${week.week}: ${week.title}`,
                        start: formatGanttDate(startDate),
                        end: formatGanttDate(endDate),
                        progress: 0,
                        custom_class: 'bar-planned'
                    }];
                }
            });

            const gantt = new Gantt("#ganttChart", ganttTasks, {
                header_height: 50,
                column_width: 30,
                step: 7,
                view_modes: ['Day', 'Week', 'Month'],
                bar_height: 20,
                bar_padding: 6,
                padding: 18,
                font_size: 14,
                language: 'ko', // í•œê¸€ ì§€ì› (Frappe Gantt ìì²´ì—ì„œ ì§€ì›í•˜ëŠ” ê²½ìš°)
                on_click: function (task) {
                    console.log(task); // í´ë¦­ ì‹œ ë””ë²„ê¹… ì •ë³´
                },
                on_date_change: function(task, start, end) {
                    console.log(task, start, end); // ë‚ ì§œ ë³€ê²½ ì‹œ (ì½ê¸° ì „ìš©ì´ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê¸°ëŠ¥ ì—†ìŒ)
                },
                on_progress_change: function(task, progress) {
                    console.log(task, progress); // ì§„í–‰ë¥  ë³€ê²½ ì‹œ
                },
                on_view_change: function(mode) {
                    console.log(mode); // ë·° ëª¨ë“œ ë³€ê²½ ì‹œ
                },
                // Frappe Gantt ì»¤ìŠ¤í…€ í´ë˜ìŠ¤ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ë§ì€ style.htmlì—ì„œ ì¶”ê°€
                custom_popup_html: function(task) {
                    // íŒì—… ë‚´ìš© ì»¤ìŠ¤í„°ë§ˆì´ì§•
                    return `
                        <div class="details-container">
                            <h5>${task.name}</h5>
                            <p>ì‹œì‘: ${task.start}</p>
                            <p>ì¢…ë£Œ: ${task.end}</p>
                            <p>ì§„í–‰ë¥ : ${task.progress}%</p>
                            ${task.custom_class === 'bar-completed' ? '<p style="color: green;">âœ… ì™„ë£Œ</p>' : ''}
                            ${task.custom_class === 'bar-in-progress' ? '<p style="color: orange;">â³ ì§„í–‰ ì¤‘</p>' : ''}
                        </div>
                    `;
                }
            });

            // ì´ˆê¸° ë·° ëª¨ë“œë¥¼ 'Week'ë¡œ ì„¤ì •
            gantt.change_view_mode('Week');


            // 2. ì£¼ì°¨ë³„ ìƒì„¸ ì¼ì • ë Œë”ë§
            const timelineDetailsContainer = document.getElementById('timelineDetails');
            timelineDetailsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

            timelineData.forEach(week => {
                const weekDetailDiv = document.createElement('div');
                weekDetailDiv.className = 'week-detail';

                let tasksHtml = '';
                if (week.tasks && week.tasks.length > 0) {
                    tasksHtml = `
                        <h5>ì„¸ë¶€ ì‘ì—…:</h5>
                        <ul>
                            ${week.tasks.map(task => `
                                <li>
                                    <span>${task.name}</span>
                                    <span>
                                        <strong class="task-duration">${task.duration}</strong>
                                        <span class="task-status ${task.status === 'ì§„í–‰ ì¤‘' ? 'in-progress' : (task.status === 'ì™„ë£Œ' ? 'completed' : '')}">${task.status}</span>
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    tasksHtml = `<p>ì„¸ë¶€ ì‘ì—…ì´ ëª…ì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                }

                let risksHtml = '';
                if (week.risks && week.risks.length > 0) {
                    risksHtml = `
                        <div class="risks-section">
                            <h5>ğŸš¨ ìœ„í—˜ ìš”ì†Œ ë° ëŒ€ì‘ ë°©ì•ˆ:</h5>
                            ${week.risks.map(risk => `
                                <p><strong>${risk.name}:</strong> ${risk.mitigation}</p>
                            `).join('')}
                        </div>
                    `;
                }

                weekDetailDiv.innerHTML = `
                    <h4>${week.week}: ${week.title}</h4>
                    <p>${week.description}</p>
                    ${tasksHtml}
                    ${risksHtml}
                `;
                timelineDetailsContainer.appendChild(weekDetailDiv);
            });

        } catch (error) {
            console.error('íƒ€ì„ë¼ì¸ ë°ì´í„° íŒŒì‹± ë˜ëŠ” ë Œë”ë§ ì˜¤ë¥˜:', error);
            alert('íƒ€ì„ë¼ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ í‘œì‹œí•˜ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            window.location.href = '<?= ScriptApp.get  Url() ?>';
        }
    });
</script>
</body>
</html>
