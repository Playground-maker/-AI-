function doGet(e) {
  const page = e.parameter.page || 'main';

  return HtmlService.createTemplateFromFile('index').evaluate()
    .setTitle('í”„ë¡œì íŠ¸ ì¼ì • ê´€ë¦¬')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function generateProjectTimeline(projectData) {
  let aiResponse = '';
  let timeline = [];

  try {
    const prompt = createPrompt(projectData);
    aiResponse = callGeminiAI(prompt);
    timeline = parseTimelineResponse(aiResponse);

    // ðŸ“¥ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì›ë³¸ ë°ì´í„° ì €ìž¥
    saveToSpreadsheet(projectData, aiResponse);

    // ðŸ“Š Gantt í˜•ì‹ ì‹œê°í™”ìš© íƒ€ìž„ë¼ì¸ ì €ìž¥
    saveGanttToSheet(timeline);

    return timeline;

  } catch (error) {
    console.error('íƒ€ìž„ë¼ì¸ ìƒì„± ì˜¤ë¥˜:', error);
    throw new Error('íƒ€ìž„ë¼ì¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
}

function saveToSpreadsheet(projectData, aiResponse) {
  const spreadsheetId = 'ì—¬ê¸°ì—_ë‹¹ì‹ ì˜_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID'; // ì˜ˆ: '1ra1JCjgB-hAkPsYiVo19YSukONObJUkTkEry0nmKHXA'
  const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
  const sheet = spreadsheet.getSheets()[0];

  const now = new Date();
  const timestamp = Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');

  if (sheet.getLastRow() === 0) {
    const headers = ['ê¸°ë¡ì¼ì‹œ', 'í”„ë¡œì íŠ¸ëª…', 'í”„ë¡œì íŠ¸ìœ í˜•', 'ì˜ˆìƒê¸°ê°„', 'íŒ€ê·œëª¨', 'ìš°ì„ ìˆœìœ„', 'ì£¼ìš”ìš”êµ¬ì‚¬í•­', 'ì œì•½ì‚¬í•­', 'AIì‘ë‹µ'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  }

  const newRow = [
    timestamp,
    projectData.projectName || '',
    projectData.projectType || '',
    projectData.duration || '',
    projectData.teamSize || '',
    projectData.priority || '',
    projectData.requirements || '',
    projectData.constraints || '',
    aiResponse || ''
  ];

  sheet.appendRow(newRow);
}

function saveGanttToSheet(timeline) {
  const spreadsheetId = 'ì—¬ê¸°ì—_ë‹¹ì‹ ì˜_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID'; // ê°™ì€ IDë¡œ ìœ ì§€
  const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
  let sheet = spreadsheet.getSheetByName('TimelineView');

  if (!sheet) {
    sheet = spreadsheet.insertSheet('TimelineView');
  } else {
    sheet.clear();
  }

  const weeks = timeline.map(item => item.period);
  const header = ['í•­ëª©ëª…', ...weeks];
  sheet.getRange(1, 1, 1, header.length).setValues([header]);

  timeline.forEach((item, index) => {
    const row = index + 2;
    sheet.getRange(row, 1).setValue(item.title);
    const col = index + 2;
    sheet.getRange(row, col).setBackground('#00c73c');
  });

  sheet.setFrozenRows(1);
  sheet.setFrozenColumns(1);
  sheet.setColumnWidths(1, weeks.length + 1, 100);
  sheet.getRange(1, 1, timeline.length + 1, weeks.length + 1).setHorizontalAlignment('center');
}

function createPrompt(projectData) {
  return `
ë‹¤ìŒ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì´ê³  ì‹¤ë¬´ì ì¸ í”„ë¡œì íŠ¸ ì¼ì •ì„ ì£¼ì°¨ë³„ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.

**í”„ë¡œì íŠ¸ ì •ë³´:**
- í”„ë¡œì íŠ¸ëª…: ${projectData.projectName}
- í”„ë¡œì íŠ¸ ìœ í˜•: ${projectData.projectType}
- ì˜ˆìƒ ê¸°ê°„: ${projectData.duration}ì£¼
- íŒ€ ê·œëª¨: ${projectData.teamSize}
- ìš°ì„ ìˆœìœ„: ${projectData.priority}
- ì£¼ìš” ìš”êµ¬ì‚¬í•­: ${projectData.requirements}
- ì œì•½ì‚¬í•­: ${projectData.constraints || 'ì—†ìŒ'}

**ìš”ì²­ì‚¬í•­:**
1. ${projectData.duration}ì£¼ ë™ì•ˆì˜ ì£¼ì°¨ë³„ ìƒì„¸ ì¼ì •ì„ ìž‘ì„±í•´ì£¼ì„¸ìš”
2. ê° ì£¼ì°¨ë³„ë¡œ êµ¬ì²´ì ì¸ ìž‘ì—… ë‚´ìš©ê³¼ ëª©í‘œë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”
3. íŒ€ ê·œëª¨ì™€ ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤í•œ í˜„ì‹¤ì ì¸ ì¼ì •ì„ ì œì•ˆí•´ì£¼ì„¸ìš”
4. ìœ„í—˜ ìš”ì†Œì™€ ëŒ€ì‘ ë°©ì•ˆë„ í¬í•¨í•´ì£¼ì„¸ìš”

**ì‘ë‹µ í˜•ì‹:** (ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ë”°ë¼ì£¼ì„¸ìš”)
ì£¼ì°¨: 1ì£¼ì°¨
ì œëª©: [ìž‘ì—… ì œëª©]
ë‚´ìš©: [êµ¬ì²´ì ì¸ ìž‘ì—… ë‚´ìš©ê³¼ ëª©í‘œ, ì‚°ì¶œë¬¼]

ì£¼ì°¨: 2ì£¼ì°¨
ì œëª©: [ìž‘ì—… ì œëª©]
ë‚´ìš©: [êµ¬ì²´ì ì¸ ìž‘ì—… ë‚´ìš©ê³¼ ëª©í‘œ, ì‚°ì¶œë¬¼]

...ì´ëŸ° ì‹ìœ¼ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.
`;
}

function callGeminiAI(prompt) {
  const apiKey = 'ì—¬ê¸°ì—_ë‹¹ì‹ ì˜_API_KEY';
  const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-pro:generateContent';

  const payload = {
    contents: [{ parts: [{ text: prompt }] }]
  };

  const options = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-goog-api-key': apiKey
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(apiUrl, options);
  const responseData = JSON.parse(response.getContentText());

  if (responseData.candidates?.[0]?.content?.parts?.[0]?.text) {
    return responseData.candidates[0].content.parts[0].text;
  } else {
    throw new Error('Gemini ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤');
  }
}

function parseTimelineResponse(aiResponse) {
  const timeline = [];
  const lines = aiResponse.split('\n');
  let currentItem = {};

  for (let line of lines) {
    line = line.trim();
    if (line.startsWith('ì£¼ì°¨:')) {
      if (currentItem.period) timeline.push(currentItem);
      currentItem = { period: line.replace('ì£¼ì°¨:', '').trim(), title: '', description: '' };
    } else if (line.startsWith('ì œëª©:')) {
      currentItem.title = line.replace('ì œëª©:', '').trim();
    } else if (line.startsWith('ë‚´ìš©:')) {
      currentItem.description = line.replace('ë‚´ìš©:', '').trim();
    } else if (line && currentItem.description) {
      currentItem.description += ' ' + line;
    }
  }

  if (currentItem.period) timeline.push(currentItem);
  return timeline.length ? timeline : createDefaultTimeline(aiResponse);
}

function createDefaultTimeline(aiResponse) {
  const paragraphs = aiResponse.split('\n\n');
  return paragraphs.map((text, i) => ({
    period: `${i + 1}ë‹¨ê³„`,
    title: `ë‹¨ê³„ ${i + 1}`,
    description: text.trim()
  }));
}
