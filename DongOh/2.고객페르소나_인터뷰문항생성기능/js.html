<script>
document.getElementById('personaForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const projectData = Object.fromEntries(formData.entries());

    console.log('í˜ë¥´ì†Œë‚˜ í¼ ë°ì´í„°:', projectData);

    // ì…ë ¥ê°’ ê²€ì¦
    if (!projectData.projectName || !projectData.projectType || !projectData.requirements) {
        showError('í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
    }

    document.getElementById('generateBtn').disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';
    document.getElementById('error').style.display = 'none';

    google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleError)
        .generatePersonaAndQuestions(projectData);
});

function handleSuccess(response) {
    console.log('í˜ë¥´ì†Œë‚˜ ìƒì„± ì„±ê³µ:', response);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('generateBtn').disabled = false;

    if (response && response.personas && response.personas.length > 0) {
        displayPersonas(response.personas);
        document.getElementById('result').style.display = 'block';

        // ì„±ê³µ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        showSuccessMessage('âœ… í˜ë¥´ì†Œë‚˜ê°€ ìƒì„±ë˜ê³  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else if (response && response.raw) {
        // íŒŒì‹±ì€ ì‹¤íŒ¨í–ˆì§€ë§Œ ì›ë³¸ í…ìŠ¤íŠ¸ëŠ” ìˆëŠ” ê²½ìš°
        displayRawResponse(response.raw);
        document.getElementById('result').style.display = 'block';

        // ì„±ê³µ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        showSuccessMessage('âœ… ì¶”ì²œì´ ìƒì„±ë˜ê³  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } else {
        showError('ì¶”ì²œ ê²°ê³¼ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

function handleError(error) {
    console.error('í˜ë¥´ì†Œë‚˜ ìƒì„± ì˜¤ë¥˜:', error);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('generateBtn').disabled = false;
    showError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || error));

    // ì˜¤ë¥˜ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    showErrorMessage('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || error));
}

function showError(message) {
    const errorElement = document.getElementById('error');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function displayPersonas(personas) {
    const area = document.getElementById('personaArea');
    area.innerHTML = '';

    personas.forEach((persona, index) => {
        if (!persona.description) return;

        const block = document.createElement('div');
        block.className = 'persona-block';

        // ì§ˆë¬¸ ëª©ë¡ HTML ìƒì„±
        let questionsHTML = '';
        if (persona.questions && persona.questions.length > 0) {
            questionsHTML = `
                <div class="persona-questions-title">ì¸í„°ë·° ì¶”ì²œ ë¬¸í•­</div>
                <ul class="persona-questions">
                    ${persona.questions.map(q => `<li>${q}</li>`).join('')}
                </ul>
            `;
        }

        block.innerHTML = `
            <div class="persona-title">${persona.title}</div>
            <div class="persona-desc">${persona.description}</div>
            ${questionsHTML}
        `;

        area.appendChild(block);

        // ìˆœì°¨ì  ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
        setTimeout(() => {
            block.classList.add('show');
        }, index * 300);
    });
}

function displayRawResponse(rawText) {
    const area = document.getElementById('personaArea');
    const block = document.createElement('div');
    block.className = 'persona-block';
    block.innerHTML = `
        <div class="persona-desc">${rawText.replace(/\n/g, '<br>')}</div>
    `;
    area.appendChild(block);

    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    setTimeout(() => {
        block.classList.add('show');
    }, 100);
}

function showSuccessMessage(message) {
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    const existingMsg = document.querySelector('.success-message');
    if (existingMsg) {
        existingMsg.remove();
    }

    // ìƒˆ ë©”ì‹œì§€ ìƒì„±
    const msgElement = document.createElement('div');
    msgElement.className = 'success-message';
    msgElement.textContent = message;

    document.body.appendChild(msgElement);

    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => {
        msgElement.classList.add('show');
    }, 100);

    // 5ì´ˆ í›„ ì œê±°
    setTimeout(() => {
        msgElement.classList.remove('show');
        setTimeout(() => {
            if (msgElement.parentNode) {
                msgElement.remove();
            }
        }, 300);
    }, 5000);
}

function showErrorMessage(message) {
    // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    const existingMsg = document.querySelector('.error-message');
    if (existingMsg) {
        existingMsg.remove();
    }

    // ìƒˆ ë©”ì‹œì§€ ìƒì„±
    const msgElement = document.createElement('div');
    msgElement.className = 'success-message error-message';
    msgElement.style.background = '#f44336';
    msgElement.textContent = message;

    document.body.appendChild(msgElement);

    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => {
        msgElement.classList.add('show');
    }, 100);

    // 7ì´ˆ í›„ ì œê±° (ì˜¤ë¥˜ëŠ” ì¢€ ë” ì˜¤ë˜ ë³´ì—¬ì¤Œ)
    setTimeout(() => {
        msgElement.classList.remove('show');
        setTimeout(() => {
            if (msgElement.parentNode) {
                msgElement.remove();
            }
        }, 300);
    }, 7000);
}

// í¼ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
document.addEventListener('DOMContentLoaded', function() {
    const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');

    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.style.borderColor = '#f44336';
            } else {
                this.style.borderColor = '#00c73c';
            }
        });

        field.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                this.style.borderColor = '#00c73c';
            }
        });
    });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ì˜ ë©”ì‹œì§€
window.addEventListener('load', function() {
    setTimeout(() => {
        showSuccessMessage('ğŸ’¡ ê³ ê° í˜ë¥´ì†Œë‚˜ ì¶”ì²œ ë„êµ¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
    }, 1000);
});
</script>
