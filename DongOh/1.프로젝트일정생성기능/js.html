<script>
    document.getElementById('projectForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const projectData = Object.fromEntries(formData.entries());

        console.log('í¼ ë°ì´í„°:', projectData);

        // UI ìƒíƒœ ë³€ê²½
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        document.getElementById('error').style.display = 'none';

        try {
            const response = await google.script.run
                .withSuccessHandler(handleSuccess)
                .withFailureHandler(handleError)
                .generateProjectTimeline(projectData);

        } catch (error) {
            handleError(error);
        }
    });

    function handleSuccess(timeline) {
        console.log('íƒ€ì„ë¼ì¸ ìƒì„± ì„±ê³µ:', timeline);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;

        if (timeline && timeline.length > 0) {
            displayTimeline(timeline);
            document.getElementById('result').style.display = 'block';

            // ì„±ê³µ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
            showSuccessMessage('âœ… íƒ€ì„ë¼ì¸ì´ ìƒì„±ë˜ê³  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } else {
            handleError('íƒ€ì„ë¼ì¸ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    function handleError(error) {
        console.error('ì˜¤ë¥˜ ë°œìƒ:', error);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('error').textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error;
        document.getElementById('error').style.display = 'block';

        // ì˜¤ë¥˜ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        showErrorMessage('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
    }

    function displayTimeline(timeline) {
        const timelineContainer = document.getElementById('timeline');
        timelineContainer.innerHTML = '';

        timeline.forEach((item, index) => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';

            // ì• ë‹ˆë©”ì´ì…˜ ë”œë ˆì´ ì¶”ê°€
            timelineItem.style.opacity = '0';
            timelineItem.style.transform = 'translateY(20px)';

            timelineItem.innerHTML = `
                <div class="timeline-date">${item.period || item.week || `${index + 1}ë‹¨ê³„`}</div>
                <div class="timeline-title">${item.title || item.task || 'ì‘ì—… í•­ëª©'}</div>
                <div class="timeline-desc">${item.description || item.details || 'ìƒì„¸ ë‚´ìš©'}</div>
            `;

            timelineContainer.appendChild(timelineItem);

            // ìˆœì°¨ì  ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            setTimeout(() => {
                timelineItem.style.transition = 'all 0.5s ease';
                timelineItem.style.opacity = '1';
                timelineItem.style.transform = 'translateY(0)';
            }, index * 150);
        });
    }

    function showSuccessMessage(message) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        const existingMsg = document.querySelector('.success-message');
        if (existingMsg) {
            existingMsg.remove();
        }

        // ìƒˆ ë©”ì‹œì§€ ìƒì„±
        const msgElement = document.createElement('div');
        msgElement.className = 'success-message';
        msgElement.textContent = message;

        document.body.appendChild(msgElement);

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        setTimeout(() => {
            msgElement.classList.add('show');
        }, 100);

        // 5ì´ˆ í›„ ì œê±°
        setTimeout(() => {
            msgElement.classList.remove('show');
            setTimeout(() => {
                if (msgElement.parentNode) {
                    msgElement.remove();
                }
            }, 300);
        }, 5000);
    }

    function showErrorMessage(message) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        const existingMsg = document.querySelector('.error-message');
        if (existingMsg) {
            existingMsg.remove();
        }

        // ìƒˆ ë©”ì‹œì§€ ìƒì„±
        const msgElement = document.createElement('div');
        msgElement.className = 'success-message error-message';
        msgElement.style.background = '#f44336';
        msgElement.textContent = message;

        document.body.appendChild(msgElement);

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        setTimeout(() => {
            msgElement.classList.add('show');
        }, 100);

        // 7ì´ˆ í›„ ì œê±° (ì˜¤ë¥˜ëŠ” ì¢€ ë” ì˜¤ë˜ ë³´ì—¬ì¤Œ)
        setTimeout(() => {
            msgElement.classList.remove('show');
            setTimeout(() => {
                if (msgElement.parentNode) {
                    msgElement.remove();
                }
            }, 300);
        }, 7000);
    }

    // í¼ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
    document.addEventListener('DOMContentLoaded', function() {
        const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');

        requiredFields.forEach(field => {
            field.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '#00c73c';
                }
            });

            field.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    this.style.borderColor = '#00c73c';
                }
            });
        });

        // ìˆ«ì ì…ë ¥ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬
        const durationField = document.getElementById('duration');
        if (durationField) {
            durationField.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1 || value > 52) {
                    this.style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '#00c73c';
                }
            });
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ì˜ ë©”ì‹œì§€
    window.addEventListener('load', function() {
        setTimeout(() => {
            showSuccessMessage('ğŸ¯ í”„ë¡œì íŠ¸ ì¼ì • ê´€ë¦¬ ë„êµ¬ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!');
        }, 1000);
    });
</script>
